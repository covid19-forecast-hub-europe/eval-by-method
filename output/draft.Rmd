---
title: "Draft"
output: html_document
params:
    scale: log
    save_dir: output
---

```{r set-up, include=FALSE}
library(here)
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)
library(patchwork)
theme_set(theme_bw())
knitr::opts_chunk$set(eval = TRUE, echo = FALSE,
                      message = FALSE, warning = FALSE)
quantiles <- c(0.01, 0.25, 0.5, 0.75, 0.99)
```

## Data preparation
```{r, eval=FALSE}
## NOT RUN
## Data creation pipeline
## Get metadata from googlesheet; save to data/
# source(here("R", "get-metadata.R"))
# get_metadata_processed()
## Get observed data and all Hub forecasts; exclude forecasts
# source(here("R", "import-data.R"))
## Create ensembles per method category; add to forecasts; save to data/
# source(here("R", "create-ensembles.R"))
## Score forecasts & ensembles on the log and natural scales; save to data/
# source(here("R", "score.R"))
```

Forecast inclusion criteria:

- Forecast date on or after 2021-03-07
- Projection target date before 2023-03-10
- Forecast includes 23 quantile predictions
- Forecast is not for an observed data anomaly

```{r load-scores}
# Load score data
scores_raw <- read_csv(here("data", "scores-raw.csv"))
scores_pairwise <- read_csv(here("data", "scores-pw.csv"))|> 
  filter(!grepl("EuroCOVIDhub-ensemble", model))
scores_pairwise_date <- read_csv(here("data", "scores-pw-target-date.csv")) |> 
  filter(!grepl("EuroCOVIDhub-ensemble", model))
scores_pairwise_horizon <- read_csv(here("data", "scores-pw-horizon.csv"))|> 
  filter(!grepl("EuroCOVIDhub-ensemble", model))
```


## Distribution of scores

```{r all-scores, fig.height = 6, fig.width = 10}
scale_cols <- c("natural" = "#d95f02", "log" = "#1b9e77")
# All scores ----------------------
plot_all_scores <- scores_pairwise |> 
  arrange(rel_wis) |> 
  mutate(model = forcats::fct_inorder(model)) |> 
  pivot_wider(names_from = scale, values_from = rel_wis) |> 
  ggplot(aes(x = model)) +
  geom_point(aes(y = natural), 
             colour = scale_cols[["natural"]]) +
  geom_point(aes(y = log), 
             colour = scale_cols[["log"]]) +
  geom_linerange(aes(ymin = log, ymax = natural), 
                 colour = "grey70") +
  geom_hline(aes(yintercept = 1), lty = 2) +
  coord_flip() +
  labs(y = "Relative WIS", x = NULL) +
  theme(legend.position = "none")

# Plot over time ----------------------------------
scores_time <- scores_pairwise_date |>
  group_by(target_end_date, scale) |>
  summarise(
    n = n(),
    value = quantile(rel_wis, quantiles),
    quantile = paste0("q", quantiles),
    model = "All models",
    .groups = "drop")

plot_all_scores_time <- scores_time |>
  pivot_wider(names_from = quantile) |>
  ggplot(aes(x = target_end_date, col = scale, fill = scale)) +
  geom_line(aes(y = q0.5), alpha = 0.5) +
  geom_ribbon(aes(ymin = q0.25, ymax = q0.75),
              alpha = 0.3, col = NA) +
    geom_ribbon(aes(ymin = q0.01, ymax = q0.99),
              alpha = 0.1, col = NA) +
  geom_hline(aes(yintercept = 1), lty = 2) +
  scale_y_log10() +
  scale_x_date(date_labels = "%b %Y") +
  scale_colour_manual(values = scale_cols, 
                      aesthetics = c("fill", "colour")) +
  labs(x = "Forecast target date", 
       y = "Relative WIS (log10)", 
       col = "Scale", fill = "Scale") +
  theme(legend.position = "bottom")

# Combine plots
plot_all <- plot_all_scores +
  plot_all_scores_time +
  patchwork::plot_annotation(tag_levels = "A") +
  patchwork::plot_layout(nrow = 1, widths = c(0.5, 1))

ggsave(plot = plot_all, filename = here("output", "plot-all-time.jpg"), height = 6, width = 10)
plot_all
```

Relative weighted interval scores (WIS) scored on a log or natural scale across 39 models. Relative WIS are the geometric mean of the interval score standardised relative to the ensemble (dashed line, 1), across any of 32 locations and up to 4 week forecast horizons. (A) Overall scores of each model across all forecast targets (predicting any of 32 locations, up to 4 weeks ahead, for 104 weeks). (B) Interquartile range across 39 models' scores by projection target date. Showing median (line) and 50% quantile interval (ribbon) across models.

---

## Categorisation
```{r describe-categories}
# Get method types
metadata <- read_csv(here("data", "model-classification.csv")) |>
  select(model, method_type = classification)

# Identify number of targets for each model by week -----------------
targets_by_model <- scores_raw |>
  filter(!grepl("EuroCOVIDhub-ensemble", model)) |>
  select(model, forecast_date, location) |>
  distinct() |>
  ungroup() |>
  group_by(model, forecast_date) |>
  summarise(target_count = n()) |>
  mutate(target_type = ifelse(target_count <= 2, "Single-country", "Multi-country")) |>
  ungroup() |>
  group_by(model) |>
  summarise(target_type = all(target_count <= 2)) |>
  mutate(target_type = factor(target_type,
                              levels = c(TRUE, FALSE),
                              labels = c("Single-country", "Multi-country")))
write_csv(targets_by_model, here("data", "targets-by-model.csv"))
head(targets_by_model)
```

---

## Model structure

Forecasting models over time by model method, including statistical (13), semi-mechanistic (9), mechanistic (12), and other (5). "Other" includes 3 human judgement ensembles and 2 ABM models.

```{r method-scores, fig.height=4, fig.width=4}
# Plot relative WIS, by groupings of model method type
method_factor <- c("Qualitative", "ABM", 
                   "Mechanistic", "Semi-mechanistic",
                   "Statistical")
names(method_factor) <- method_factor

scores_method <- scores_pairwise_horizon |>
  left_join(metadata, by = "model") |> 
  filter(scale == params$scale) |> 
  mutate(method_type = factor(method_type, 
                              method_factor, names(method_factor),
                              ordered = TRUE)) 

scores_method_all <- scores_method |> 
  filter(!grepl("ABM|Qualitative", method_type)) |> 
  group_by(method_type, horizon) |>
  summarise(
    n = n(),
    value = quantile(rel_wis, quantiles),
    quantile = paste0("q", quantiles),
    .groups = "drop")

scores_method_other <- scores_method |> 
  filter(grepl("ABM|Qualitative", method_type)) |> 
  select(model, method_type, horizon, value = rel_wis) |> 
  mutate(quantile = "q0.5", n = 1)

plot_scores_method <- scores_method_all |> 
  bind_rows(scores_method_other) |> 
  pivot_wider(names_from = quantile) |>
  mutate(horizon = as.factor(horizon)) |> 
  ggplot(aes(y = method_type, col = horizon, fill = horizon)) +
  geom_point(aes(x = q0.5), alpha = 0.8, position = position_dodge(width = 1)) +
  geom_linerange(aes(xmin = q0.25, xmax = q0.75), linewidth = 4,
                 alpha = 0.5, position = position_dodge(width = 1)) +
    geom_linerange(aes(xmin = q0.01, xmax = q0.99), linewidth = 4,
                 alpha = 0.2, position = position_dodge(width = 1)) +
  geom_vline(xintercept = 1, lty = 2) +
    labs(y = NULL, x = NULL,
       col = "Week ahead forecast horizon",
       fill = "Week ahead forecast horizon") +
  scale_color_viridis_d(direction = 1) +
  theme(legend.position = "bottom")
```

---

## Target specificity

Single country models includes models that forecast for at most 2 countries at any time. Multi-country models includes more than 2 countries, in practice, this was a minimum of 14 and up to 32 countries.

```{r eval-by-target}
# Get countries with single target models
scores_targets <- scores_raw |>
  left_join(targets_by_model, by = c("model"))
target_single <- scores_targets |>
  filter(target_type == "Single-country") |>
  group_by(location) |>
  summarise(models = n_distinct(model)) |>
  arrange(desc(models))
cat("16 single target models were for: ")
cat(paste0(target_single$location, " (", target_single$models, "),"))
target_multi <- scores_targets |>
  filter(target_type == "Multi-country") |>
  group_by(model) |>
  summarise(locations = n_distinct(location)) |>
  arrange(desc(locations))
cat(paste(nrow(target_multi), "multi-country models."))
```

```{r scores-by-target, fig.height=4, fig.width=4}
scores_targets <- scores_pairwise_horizon |>
  left_join(targets_by_model, by = "model") 

plot_scores_targets <- scores_targets |> 
  filter(scale == params$scale) |>
  group_by(target_type, horizon) |>
  summarise(
    n = n(),
    value = quantile(rel_wis, quantiles),
    quantile = paste0("q", quantiles),
    .groups = "drop")
plot_scores_targets <- plot_scores_targets |> 
  pivot_wider(names_from = quantile) |>
  mutate(horizon = as.factor(horizon)) |> 
  ggplot(aes(y = target_type, col = horizon, fill = horizon)) +
  geom_point(aes(x = q0.5), alpha = 0.8, position = position_dodge(width = 1)) +
  geom_linerange(aes(xmin = q0.25, xmax = q0.75), linewidth = 4,
                 alpha = 0.5, position = position_dodge(width = 1)) +
    geom_linerange(aes(xmin = q0.01, xmax = q0.99), linewidth = 4,
                 alpha = 0.2, position = position_dodge(width = 1)) +
  geom_vline(xintercept = 1, lty = 2) +
    labs(y = NULL, x = NULL,
       col = "Week ahead forecast horizon",
       fill = "Week ahead forecast horizon") +
  scale_color_viridis_d(direction = 1) +
  theme(legend.position = "none")
```

Performance by horizon and model target type, where single-country indicates a model only forecast for at most 2 countries at any time.

```{r scores-by-both, fig.height=4, fig.width=8}
plot_method_target <- plot_scores_method +
  plot_scores_targets +
  patchwork::plot_annotation(tag_levels = "A") +
  patchwork::plot_layout(nrow = 1, guides = "collect") &
  theme(legend.position = "bottom")

ggsave(plot = plot_method_target, 
       filename = here(params$save_dir, "plot-method-target.jpg"),
       height = 4, width = 8)

plot_method_target
```

Range of scores by type of model and forecast horizon, showing 50% and 99% quantile interval.

```{r supplement, eval=FALSE, include = FALSE}
rmarkdown::render(here("output", "draft.Rmd"), 
                  params = list(scale = "natural",
                                save_dir = "supplement"), 
                  output_dir = params$save_dir)
```
